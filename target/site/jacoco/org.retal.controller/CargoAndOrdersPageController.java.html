<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>CargoAndOrdersPageController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Logiweb Service</a> &gt; <a href="index.source.html" class="el_package">org.retal.controller</a> &gt; <span class="el_source">CargoAndOrdersPageController.java</span></div><h1>CargoAndOrdersPageController.java</h1><pre class="source lang-java linenums">package org.retal.controller;

import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.stream.Collectors;
import org.retal.domain.Car;
import org.retal.domain.Cargo;
import org.retal.domain.Order;
import org.retal.domain.SessionInfo;
import org.retal.domain.User;
import org.retal.domain.UserInfo;
import org.retal.dto.RoutePointDTO;
import org.retal.dto.RoutePointListWrapper;
import org.retal.service.CarService;
import org.retal.service.CargoAndOrdersService;
import org.retal.service.CityService;
import org.retal.service.UserValidator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.ResponseBody;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import org.springframework.web.servlet.view.RedirectView;

@Controller
public class CargoAndOrdersPageController {

  private final SessionInfo sessionInfo;

  private final CargoAndOrdersService cargoAndOrdersService;

  private final CityService cityService;

  private final CarService carService;

  /**
   * Creates an instance of this class using constructor-based dependency injection.
   */
  @Autowired
<span class="fc" id="L45">  public CargoAndOrdersPageController(SessionInfo sessionInfo,</span>
      CargoAndOrdersService cargoAndOrdersService, CityService cityService, CarService carService) {
<span class="fc" id="L47">    this.sessionInfo = sessionInfo;</span>
<span class="fc" id="L48">    this.cargoAndOrdersService = cargoAndOrdersService;</span>
<span class="fc" id="L49">    this.cityService = cityService;</span>
<span class="fc" id="L50">    this.carService = carService;</span>
<span class="fc" id="L51">  }</span>

  /**
   * Method responsible for showing the main page for cargo and orders.
   */
  @GetMapping(value = &quot;/cargoAndOrders&quot;)
  public String getCargoAndOrdersPage(Model model) {
<span class="nc" id="L58">    BindingResult result =</span>
<span class="nc" id="L59">        (BindingResult) model.asMap().get(BindingResult.MODEL_KEY_PREFIX + &quot;routePoints&quot;);</span>
<span class="nc" id="L60">    Map&lt;String, String&gt; errors = UserValidator.convertErrorsToHashMap(result);</span>
<span class="nc" id="L61">    model.addAllAttributes(errors);</span>
<span class="nc" id="L62">    User user = sessionInfo.getCurrentUser();</span>
<span class="nc" id="L63">    UserInfo userInfo = user.getUserInfo();</span>
<span class="nc" id="L64">    model.addAttribute(&quot;current_user_name&quot;, userInfo.getName() + &quot; &quot; + userInfo.getSurname());</span>
<span class="nc" id="L65">    model.addAttribute(&quot;cargoList&quot;, cargoAndOrdersService.getAllCargo());</span>
<span class="nc" id="L66">    model.addAttribute(&quot;availableCargoList&quot;, getAllCitiesAndAssignableCargo()[1]);</span>
<span class="nc" id="L67">    List&lt;Order&gt; orders = cargoAndOrdersService.getAllOrders();</span>
<span class="nc" id="L68">    model.addAttribute(&quot;ordersList&quot;, orders);</span>
<span class="nc" id="L69">    model.addAttribute(&quot;cityList&quot;, cityService.getAllCities());</span>
<span class="nc" id="L70">    List&lt;Boolean&gt; isOrderStarted = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L71">    List&lt;Boolean&gt; hasCarsAvailable = new ArrayList&lt;&gt;();</span>
<span class="nc" id="L72">    orders.forEach(o -&gt; {</span>
<span class="nc" id="L73">      isOrderStarted.add(cargoAndOrdersService.isOrderStarted(o));</span>
<span class="nc" id="L74">      List&lt;Car&gt; cars = getAvailableCarsForOrder(o.getId());</span>
<span class="nc bnc" id="L75" title="All 4 branches missed.">      hasCarsAvailable.add(cars != null &amp;&amp; cars.size() != 0);</span>
<span class="nc" id="L76">    });</span>
<span class="nc" id="L77">    model.addAttribute(&quot;orderStarted&quot;, isOrderStarted);</span>
<span class="nc" id="L78">    model.addAttribute(&quot;hasCarsAvailable&quot;, hasCarsAvailable);</span>
<span class="nc" id="L79">    return &quot;cargo_orders&quot;;</span>
  }

  /**
   * Method for AJAX requests. Required for adding orders (form is generated dynamically using JS).
   * 
   * @return List array of 2 elements. List[0] is all {@linkplain org.retal.domain.City cities} from
   *         database. List[1] is all {@linkplain org.retal.domain.Cargo cargo} available for
   *         creating order.
   */
  @SuppressWarnings(&quot;rawtypes&quot;)
  @GetMapping(value = &quot;/getCityAndCargoInfo&quot;)
  @ResponseBody
  public List[] getAllCitiesAndAssignableCargo() {
<span class="fc" id="L93">    List&lt;Cargo&gt; cargo = cargoAndOrdersService.getAllCargo().stream()</span>
<span class="fc bfc" id="L94" title="All 2 branches covered.">        .filter(c -&gt; c.getPoints().size() == 0).collect(Collectors.toList());</span>
    /*
     * for (int i = 0; i &lt; cargo.size(); i++) { if (cargo.get(i).getPoints().size() != 0) {
     * cargo.remove(i); i--; } }
     */
<span class="fc" id="L99">    return new List[] {cityService.getAllCities(), cargo};</span>
  }

  /**
   * Method for AJAX requests. Required for reassigning car for order.
   * 
   * @param id {@linkplain org.retal.domain.Order Order} primary key
   * @return List of {@linkplain org.retal.domain.Car Cars} available for assigning to this order.
   */
  @GetMapping(value = &quot;/getCarsForOrder/{id}&quot;)
  @ResponseBody
  public List&lt;Car&gt; getAvailableCarsForOrder(@PathVariable Integer id) {
<span class="nc" id="L111">    return carService.getAllAvailableCarsForOrderId(id);</span>
  }

  /**
   * Method for AJAX requests. Required for changing assigned car for order
   * 
   * @param data input data of pattern &quot;A_B&quot; where A is {@linkplain org.retal.domain.Order Order} ID
   *        and B is {@linkplain org.retal.domain.Car Car} registration ID
   * @return error message if operation failed and null if operation succeeded.
   * @see org.retal.service.CargoAndOrdersService
   */
  @GetMapping(value = &quot;/changeCarForOrder/{data}&quot;)
  @ResponseBody
  public String changeCarForOrder(@PathVariable String data) {
<span class="nc" id="L125">    return cargoAndOrdersService.tryToChangeOrderCar(data);</span>
  }

  /**
   * Method responsible for adding new order from form using
   * {@linkplain org.retal.service.CargoAndOrdersService service layer}.
   * 
   */
  @PostMapping(value = &quot;/addNewOrder&quot;)
  public RedirectView addNewOrder(RoutePointListWrapper list, BindingResult bindingResult,
      RedirectAttributes redir) {
<span class="fc" id="L136">    redir.addFlashAttribute(&quot;visible&quot;, &quot;true&quot;);</span>
<span class="fc bfc" id="L137" title="All 2 branches covered.">    if(list.getList() == null) {</span>
<span class="fc" id="L138">      list.setList(new ArrayList&lt;RoutePointDTO&gt;());</span>
    }
<span class="fc" id="L140">    cargoAndOrdersService.createOrderAndRoutePoints(list, bindingResult);</span>
<span class="fc bfc" id="L141" title="All 2 branches covered.">    if (bindingResult.hasErrors()) {</span>
<span class="fc" id="L142">      redir.addFlashAttribute(BindingResult.MODEL_KEY_PREFIX + &quot;routePoints&quot;, bindingResult);</span>
<span class="fc" id="L143">      redir.addFlashAttribute(&quot;counter_value&quot;, list.getList().size());</span>
<span class="fc" id="L144">      redir.addFlashAttribute(&quot;routePoints&quot;, list.getList());</span>
    }
<span class="fc" id="L146">    RedirectView redirectView = new RedirectView(&quot;/cargoAndOrders&quot;, true);</span>
<span class="fc" id="L147">    return redirectView;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>