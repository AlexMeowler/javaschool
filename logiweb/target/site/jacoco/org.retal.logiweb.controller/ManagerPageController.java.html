<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="ru"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>ManagerPageController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">logiweb</a> &gt; <a href="index.source.html" class="el_package">org.retal.logiweb.controller</a> &gt; <span class="el_source">ManagerPageController.java</span></div><h1>ManagerPageController.java</h1><pre class="source lang-java linenums">package org.retal.logiweb.controller;

import java.util.List;
import java.util.Map;
import org.apache.log4j.Logger;
import org.retal.logiweb.domain.entity.Car;
import org.retal.logiweb.domain.entity.City;
import org.retal.logiweb.domain.entity.SessionInfo;
import org.retal.logiweb.domain.entity.User;
import org.retal.logiweb.domain.entity.UserInfo;
import org.retal.logiweb.domain.enums.UserRole;
import org.retal.logiweb.dto.CarDTO;
import org.retal.logiweb.dto.CityDTO;
import org.retal.logiweb.dto.UserDTO;
import org.retal.logiweb.dto.UserInfoDTO;
import org.retal.logiweb.service.logic.CarService;
import org.retal.logiweb.service.logic.CityService;
import org.retal.logiweb.service.logic.UserService;
import org.retal.logiweb.service.validators.UserValidator;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Controller;
import org.springframework.ui.Model;
import org.springframework.validation.BindingResult;
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.PathVariable;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.servlet.mvc.support.RedirectAttributes;
import org.springframework.web.servlet.view.RedirectView;

@Controller
public class ManagerPageController {

  private final SessionInfo sessionInfo;

  private final UserService userService;

  private final CarService carService;

  private final CityService cityService;

  public static final String MANAGER_PAGE = &quot;/managerPage&quot;;

  private static final String CITY_LIST_ATTRIBUTE_NAME = &quot;cityList&quot;;

<span class="fc" id="L46">  private static final Logger log = Logger.getLogger(ManagerPageController.class);</span>

  /**
   * Creates an instance of this class using constructor-based dependency injection.
   */
  @Autowired
  public ManagerPageController(SessionInfo sessionInfo, UserService userService,
<span class="fc" id="L53">      CarService carService, CityService cityService) {</span>
<span class="fc" id="L54">    this.sessionInfo = sessionInfo;</span>
<span class="fc" id="L55">    this.userService = userService;</span>
<span class="fc" id="L56">    this.carService = carService;</span>
<span class="fc" id="L57">    this.cityService = cityService;</span>
<span class="fc" id="L58">  }</span>

  /**
   * Method responsible for showing manager page.
   */
  @GetMapping(value = MANAGER_PAGE)
  public String getManagerPage(Model model) {
<span class="fc" id="L65">    BindingResult userResult =</span>
<span class="fc" id="L66">        (BindingResult) model.asMap().get(BindingResult.MODEL_KEY_PREFIX + &quot;user&quot;);</span>
<span class="fc" id="L67">    Map&lt;String, String&gt; errors = UserValidator.convertErrorsToHashMap(userResult);</span>
<span class="fc bfc" id="L68" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; e : errors.entrySet()) {</span>
<span class="fc" id="L69">      log.debug(e.getKey() + &quot;:&quot; + e.getValue());</span>
<span class="fc" id="L70">    }</span>
<span class="fc" id="L71">    model.addAllAttributes(errors);</span>
<span class="fc" id="L72">    BindingResult carResult =</span>
<span class="fc" id="L73">        (BindingResult) model.asMap().get(BindingResult.MODEL_KEY_PREFIX + &quot;car&quot;);</span>
<span class="fc" id="L74">    errors = UserValidator.convertErrorsToHashMap(carResult);</span>
<span class="fc bfc" id="L75" title="All 2 branches covered.">    for (Map.Entry&lt;String, String&gt; e : errors.entrySet()) {</span>
<span class="fc" id="L76">      log.debug(e.getKey() + &quot;:&quot; + e.getValue());</span>
<span class="fc" id="L77">    }</span>
<span class="fc" id="L78">    model.addAllAttributes(errors);</span>
<span class="fc" id="L79">    User user = sessionInfo.getCurrentUser();</span>
<span class="fc" id="L80">    UserInfo userInfo = user.getUserInfo();</span>
<span class="fc" id="L81">    model.addAttribute(&quot;current_user_name&quot;, userInfo.getName() + &quot; &quot; + userInfo.getSurname());</span>
<span class="fc" id="L82">    List&lt;User&gt; users = userService.getAllDrivers();</span>
<span class="fc" id="L83">    model.addAttribute(&quot;driverList&quot;, users);</span>
<span class="fc" id="L84">    List&lt;Car&gt; cars = carService.getAllCars();</span>
<span class="fc" id="L85">    model.addAttribute(&quot;carsList&quot;, cars);</span>
<span class="fc" id="L86">    List&lt;City&gt; cities = cityService.getAllCities();</span>
<span class="fc" id="L87">    model.addAttribute(CITY_LIST_ATTRIBUTE_NAME, cities);</span>
<span class="fc" id="L88">    return &quot;managerPage&quot;;</span>
  }

  /**
   * Method responsible for adding new drivers to database using
   * {@linkplain org.retal.logiweb.service.logic.UserService service layer}.
   * 
   * @see org.retal.logiweb.domain.entity.User
   */
  @PostMapping(value = &quot;/addNewDriver&quot;)
  public RedirectView addNewDriver(UserDTO userDTO, UserInfoDTO userInfoDTO, CityDTO cityDTO,
      RedirectAttributes redir, BindingResult bindingResult) {
<span class="fc" id="L100">    log.info(&quot;Attempt to add new driver&quot;);</span>
<span class="fc" id="L101">    redir.addFlashAttribute(&quot;visibledriver&quot;, &quot;true&quot;);</span>
<span class="fc" id="L102">    User user = mapUserRelatedDTOsToDriverEntity(userDTO, userInfoDTO, cityDTO);</span>
<span class="fc" id="L103">    userService.addNewUser(user, bindingResult, userDTO.getPassword());</span>
<span class="fc bfc" id="L104" title="All 2 branches covered.">    if (bindingResult.hasErrors()) {</span>
<span class="fc" id="L105">      log.warn(&quot;Validation failed when adding new driver&quot;);</span>
<span class="fc" id="L106">      redir.addFlashAttribute(BindingResult.MODEL_KEY_PREFIX + &quot;user&quot;, bindingResult);</span>
<span class="fc" id="L107">      redir.addFlashAttribute(&quot;user&quot;, user);</span>
    }
<span class="fc" id="L109">    return new RedirectView(MANAGER_PAGE, true);</span>
  }

  /**
   * Method responsible for attempt to delete driver from database when button is clicked using
   * {@linkplain org.retal.logiweb.service.logic.UserService service layer}.
   * 
   * @see org.retal.logiweb.domain.entity.User
   */
  @GetMapping(value = &quot;/deleteDriver/{id}&quot;)
  public RedirectView deleteDriver(@PathVariable Integer id, RedirectAttributes redir) {
<span class="fc" id="L120">    RedirectView redirectView = new RedirectView(MANAGER_PAGE, true);</span>
<span class="fc" id="L121">    String url403 = userService.deleteUser(id);</span>
<span class="fc bfc" id="L122" title="All 4 branches covered.">    if (!url403.isEmpty() &amp;&amp; !url403.equals(UserService.DELETION_UPDATION_ERROR)) {</span>
<span class="fc" id="L123">      String param = sessionInfo.getCurrentUser().getLogin();</span>
<span class="fc" id="L124">      redirectView.setUrl(url403 + &quot;/&quot; + param);</span>
    }
<span class="fc bfc" id="L126" title="All 2 branches covered.">    if (url403.equals(UserService.DELETION_UPDATION_ERROR)) {</span>
<span class="fc" id="L127">      redir.addFlashAttribute(&quot;error_userDeletionFailed&quot;,</span>
          &quot;Could not delete driver due to assigned order or being driving car&quot;);
    }
<span class="fc" id="L130">    return redirectView;</span>
  }

  /**
   * Method responsible for redirecting to driver editor page.
   * 
   * @see org.retal.logiweb.domain.entity.User
   */
  @GetMapping(value = &quot;/editDriver/{id}&quot;)
  public RedirectView editDriver(@PathVariable Integer id, RedirectAttributes redir) {
<span class="fc" id="L140">    RedirectView redirectView = new RedirectView(&quot;/editDriver&quot;, true);</span>
<span class="fc" id="L141">    User we = sessionInfo.getCurrentUser();</span>
<span class="fc" id="L142">    User target = userService.getUser(id);</span>
<span class="fc bfc" id="L143" title="All 2 branches covered.">    if (userService.userHasRightsToEditOrDeleteUser(we, target)) {</span>
<span class="fc" id="L144">      redir.addFlashAttribute(&quot;user&quot;, target);</span>
<span class="fc" id="L145">      redir.addFlashAttribute(&quot;we&quot;, we);</span>
    } else {
<span class="fc" id="L147">      redirectView.setUrl(&quot;/403/&quot; + we.getLogin());</span>
    }
<span class="fc" id="L149">    return redirectView;</span>
  }

  /**
   * Method responsible for showing driver editor page.
   * 
   * @see org.retal.logiweb.domain.entity.User
   */
  @GetMapping(value = &quot;/editDriver&quot;)
  public String driverEditForm(Model model) {
<span class="fc" id="L159">    BindingResult result =</span>
<span class="fc" id="L160">        (BindingResult) model.asMap().get(BindingResult.MODEL_KEY_PREFIX + &quot;user&quot;);</span>
<span class="fc" id="L161">    Map&lt;String, String&gt; errors = UserValidator.convertErrorsToHashMap(result);</span>
<span class="fc" id="L162">    model.addAllAttributes(errors);</span>
<span class="fc" id="L163">    model.addAttribute(&quot;editUser&quot;, &quot;/submitEditedDriver&quot;);</span>
<span class="fc" id="L164">    List&lt;City&gt; cities = cityService.getAllCities();</span>
<span class="fc" id="L165">    model.addAttribute(CITY_LIST_ATTRIBUTE_NAME, cities);</span>
<span class="fc" id="L166">    return &quot;editUser&quot;;</span>
  }

  /**
   * Method responsible for submitting edited driver to
   * {@linkplain org.retal.logiweb.service.logic.UserService service layer} which will update entity if
   * input is valid.
   * 
   * @see org.retal.logiweb.domain.entity.User
   */
  @PostMapping(value = &quot;/submitEditedDriver&quot;)
  public RedirectView finishDriverEditing(UserDTO userDTO, BindingResult bindingResult,
      UserInfoDTO userInfoDTO, CityDTO cityDTO, RedirectAttributes redir) {
<span class="fc" id="L179">    RedirectView redirectView = new RedirectView(MANAGER_PAGE, true);</span>
<span class="fc" id="L180">    User user = mapUserRelatedDTOsToDriverEntity(userDTO, userInfoDTO, cityDTO);</span>
<span class="fc" id="L181">    String redirect = userService.updateUser(user, bindingResult, userDTO.getPassword());</span>
<span class="fc bfc" id="L182" title="All 2 branches covered.">    if (bindingResult.hasErrors()) {</span>
<span class="fc" id="L183">      log.warn(&quot;There were validation errors at editing driver&quot;);</span>
<span class="fc" id="L184">      redir.addFlashAttribute(BindingResult.MODEL_KEY_PREFIX + &quot;user&quot;, bindingResult);</span>
<span class="fc" id="L185">      redir.addFlashAttribute(&quot;user&quot;, user);</span>
<span class="fc" id="L186">      redirectView.setUrl(&quot;/editDriver&quot;);</span>
    }
<span class="fc bfc" id="L188" title="All 2 branches covered.">    if (!redirect.isEmpty()) {</span>
<span class="fc" id="L189">      redirectView.setUrl(redirect);</span>
    }
<span class="fc" id="L191">    return redirectView;</span>
  }

  /**
   * Method responsible for adding new cars to database using
   * {@linkplain org.retal.logiweb.service.logic.CarService service layer}.
   * 
   * @see org.retal.logiweb.domain.entity.Car
   */
  @PostMapping(value = &quot;/addNewCar&quot;)
  public RedirectView addNewCar(CarDTO carDTO, BindingResult bindingResult, CityDTO cityDTO,
      RedirectAttributes redir, @RequestParam(name = &quot;capacity&quot;) String capacity,
      @RequestParam(name = &quot;shift&quot;) String shiftLength) {
<span class="fc" id="L204">    redir.addFlashAttribute(&quot;visiblecar&quot;, &quot;true&quot;);</span>
<span class="fc" id="L205">    Car car = mapCarRelatedDTOsToCarEntity(carDTO, cityDTO);</span>
<span class="fc" id="L206">    carService.addNewCar(car, bindingResult, capacity, shiftLength);</span>
<span class="fc bfc" id="L207" title="All 2 branches covered.">    if (bindingResult.hasErrors()) {</span>
<span class="fc" id="L208">      log.warn(&quot;There were validation errors at adding new car&quot;);</span>
<span class="fc" id="L209">      redir.addFlashAttribute(BindingResult.MODEL_KEY_PREFIX + &quot;car&quot;, bindingResult);</span>
<span class="fc" id="L210">      redir.addFlashAttribute(&quot;car&quot;, car);</span>
    }
<span class="fc" id="L212">    return new RedirectView(MANAGER_PAGE, true);</span>
  }

  /**
   * Method responsible for attempt to delete car from database when button is clicked using
   * {@linkplain org.retal.logiweb.service.logic.CarService service layer}.
   * 
   * @see org.retal.logiweb.domain.entity.Car
   */
  @GetMapping(value = &quot;/deleteCar/{id}&quot;)
  public RedirectView deleteCar(@PathVariable String id, RedirectAttributes redir) {
<span class="fc" id="L223">    RedirectView redirectView = new RedirectView(MANAGER_PAGE, true);</span>
<span class="fc" id="L224">    Car car = carService.getCar(id);</span>
<span class="fc bfc" id="L225" title="All 2 branches covered.">    if (!carService.deleteCar(car)) {</span>
<span class="fc" id="L226">      redir.addFlashAttribute(&quot;error_carDeletionFailed&quot;,</span>
          &quot;Could not delete car due to assigned order or being driven by someone&quot;);
    }
<span class="fc" id="L229">    return redirectView;</span>
  }

  /**
   * Method responsible for redirecting to car editor page.
   * 
   * @see org.retal.logiweb.domain.entity.Car
   */
  @GetMapping(value = &quot;/editCar/{id}&quot;)
  public RedirectView editCar(@PathVariable String id, RedirectAttributes redir) {
<span class="fc" id="L239">    RedirectView redirectView = new RedirectView(&quot;/editCar&quot;, true);</span>
<span class="fc" id="L240">    redir.addFlashAttribute(&quot;car&quot;, carService.getCar(id));</span>
<span class="fc" id="L241">    return redirectView;</span>
  }

  /**
   * Method responsible for showing car editor page.
   * 
   * @see org.retal.logiweb.domain.entity.Car
   */
  @GetMapping(value = &quot;/editCar&quot;)
  public String carEditForm(Model model) {
<span class="fc" id="L251">    BindingResult result =</span>
<span class="fc" id="L252">        (BindingResult) model.asMap().get(BindingResult.MODEL_KEY_PREFIX + &quot;car&quot;);</span>
<span class="fc" id="L253">    Map&lt;String, String&gt; errors = UserValidator.convertErrorsToHashMap(result);</span>
<span class="fc" id="L254">    model.addAllAttributes(errors);</span>
<span class="fc" id="L255">    List&lt;City&gt; cities = cityService.getAllCities();</span>
<span class="fc" id="L256">    model.addAttribute(CITY_LIST_ATTRIBUTE_NAME, cities);</span>
<span class="fc" id="L257">    return &quot;editCar&quot;;</span>
  }

  /**
   * Method responsible for submitting edited car to
   * {@linkplain org.retal.logiweb.service.logic.CarService service layer} which will update car if input
   * is valid.
   * 
   * @see org.retal.logiweb.domain.entity.Car
   */
  @PostMapping(value = &quot;/submitEditedCar&quot;)
  public RedirectView finishCarEditing(CarDTO carDTO, BindingResult bindingResult,
      RedirectAttributes redir, @RequestParam(name = &quot;capacity&quot;) String capacity,
      @RequestParam(name = &quot;shift&quot;) String shiftLength, CityDTO cityDTO) {
<span class="fc" id="L271">    RedirectView redirectView = new RedirectView(MANAGER_PAGE, true);</span>
<span class="fc" id="L272">    Car car = mapCarRelatedDTOsToCarEntity(carDTO, cityDTO);</span>
<span class="fc" id="L273">    carService.updateCar(car, bindingResult, capacity, shiftLength);</span>
<span class="fc bfc" id="L274" title="All 2 branches covered.">    if (bindingResult.hasErrors()) {</span>
<span class="fc" id="L275">      log.warn(&quot;There were validation errors at editing car&quot;);</span>
<span class="fc" id="L276">      redir.addFlashAttribute(BindingResult.MODEL_KEY_PREFIX + &quot;car&quot;, bindingResult);</span>
<span class="fc" id="L277">      redir.addFlashAttribute(&quot;car&quot;, car);</span>
<span class="fc" id="L278">      redirectView.setUrl(&quot;/editCar&quot;);</span>
    }
<span class="fc" id="L280">    return redirectView;</span>
  }

  /**
   * Method for mapping user related DTOs (user, user info, city) to
   * {@linkplain org.retal.logiweb.domain.entity.User User} entity with user role set to 'driver'.
   * 
   * @param userDTO instance of {@linkplain org.retal.logiweb.dto.UserDTO}
   * @param userInfoDTO instance of {@linkplain org.retal.logiweb.dto.UserInfoDTO}
   * @param cityDTO instance of {@linkplain org.retal.logiweb.dto.CityDTO}
   * @return transient instance of {@linkplain org.retal.logiweb.domain.entity.User User} driver entity
   */
  private User mapUserRelatedDTOsToDriverEntity(UserDTO userDTO, UserInfoDTO userInfoDTO,
      CityDTO cityDTO) {
<span class="fc" id="L294">    User user = new User(userDTO);</span>
<span class="fc" id="L295">    UserInfo userInfo = new UserInfo(userInfoDTO);</span>
<span class="fc" id="L296">    City city = new City(cityDTO);</span>
<span class="fc" id="L297">    user.setRole(UserRole.DRIVER.toString().toLowerCase());</span>
<span class="fc" id="L298">    userInfo.setCity(city);</span>
<span class="fc" id="L299">    user.setUserInfo(userInfo);</span>
<span class="fc" id="L300">    return user;</span>
  }

  /**
   * Method for mapping car related DTOs (car, city) to {@linkplain org.retal.logiweb.domain.entity.Car
   * Car} entity with user role set to 'driver'.
   * 
   * @param carDTO instance of {@linkplain org.retal.logiweb.dto.CarDTO}
   * @param cityDTO instance of {@linkplain org.retal.logiweb.dto.CityDTO}
   * @return transient instance of {@linkplain org.retal.logiweb.domain.entity.Car Car} entity
   */
  private Car mapCarRelatedDTOsToCarEntity(CarDTO carDTO, CityDTO cityDTO) {
<span class="fc" id="L312">    Car car = new Car(carDTO);</span>
<span class="fc" id="L313">    City city = new City(cityDTO);</span>
<span class="fc" id="L314">    car.setLocation(city);</span>
<span class="fc" id="L315">    return car;</span>
  }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.6.202009150832</span></div></body></html>